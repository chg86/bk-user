# 数据同步 API 协议

数据同步 API 协议旨在约定 用户&架构信息的提供方（以下简称提供方）和 用户管理（以下简称同步方）之间的数据同步方式。

以下除了标记为 `非一期目标` ，均为一期目标。

## 使用方式

提供方需要实现提供数据的拉取 API，然后将接口相关信息配置在用户管理中，即可实现数据同步。

## API 规范

- API 保持 restFul 风格
- 提供“打平”的数据：接口提供简单的数据列表，数据之间的关系通过简单字段关联
- 正常返回的结果需要放到 `results` 字段中，其他任何异常直接以 `Http Status Code` 的形式暴露，例如 `400 Bad Request`
- 单个接口拉取默认的超时时间为 30s（可配置）

## API 鉴权（非一期目标）

支持 [Bearer Token](https://tools.ietf.org/html/rfc6750) ，可以在用户管理 SaaS 中配置目录。

请求头示例

```
Authorization: Bearer YWxhZGRpbjpvcGVuc2VzYW1l
```

## 拉取用户列表

请求方法： `GET`

预期的返回体结构：

```json
{
  "count": 100,
  "results": [
  {
    # 该字段将作为蓝鲸体系中的用户标识，一旦写入则不能够修改，请谨慎处理
    "username": "jackma",
    "display_name": "码昀",
    # 数据提供系统中的唯一标识（可以包含特殊字符）
    "code": "abcd-efgh-wxyz",
    # 上级的 code 列表
    "leaders": ["aaaa-bbbb-cccc", "qqqq-eeee-wwww"],
    # 所属组织的 code 列表
    "departments": ["aaa", "bbb", "ccc", "ddd"],
    "email": "123456@123.com",
    "telephone": "13112341234",
    "extras": {
    # 需要和配置中的额外字段配合，这里只是例子
      "gender": "male"
    }
  },
  {
    "username": "robinli",
    "display_name": "立颜洪",
    "code": "abcd-efgh-qwer",
    # 上级的 code 列表
    "leaders": ["aaaa-bbbb-cccc", "qqqq-eeee-wwww"],
    # 所属组织的 code 列表
    "departments": ["aaa", "bbb", "ccc", "ddd"],
    "email": "123456@abc.com",
    "telephone": "13112341234",
    "extras": {
    # 需要和配置中的额外字段配合，这里只是例子
      "gender": "male"
    }
  }
}
```

### code & username 字段释义

`username` 和 `code` 需要保持一一对应的关系，如果业务系统不存在额外的 `code` ，那么二者可以保持取值一致。

不同之处在于：

- `username` 是在蓝鲸体系中标记用户的唯一键值，需要作为登录名使用，所以需要具备**可读、可记忆性**。
- `code` 可以是提供方系统中的唯一键值，不需要作为登录或者展示使用，**仅作为后台唯一校验**。

更具体地来说，每次进行数据同步时，用户管理会通过 `code` 判断用户对象存在与否，决定是新增还是修改，而 `username` 只会在第一次新增时写入，后续不会随着提供方的 API 修改。

(`username` 规范: 由1-32位字母、数字、下划线(_)、点(.)、减号(-)字符组成，以字母或数字开头)

### departments 字段释义

`departments` 字段表示用户所属的组织列表，由所有所属的组织 `code` 组成，需要在提供前保证对应组织的存在性，并且对列表进行去重。当用户无所属组织时，提供空列表。

### leaders 字段释义

`leaders` 表示用户的上级列表，由所有的上级 `code` 组成。需要确保这些 `code` 在这次整体拉取中存在。

### extras 字段释义

`extras` 字段是对应在【用户管理 SaaS】 -【字段设置】 中配置的 **非内建字段，**只有配置过的字段才会被同步。

例如，SaaS 中配置了自定义字段: `gender` 作为性别标识，那么在数据提供时，需要将 `gender` 的内容塞入到 `extras` 中。更多例子如下：

```json
{
  "extras": {
    "gender": "male",
    "level": 1,
  }
}
```

### 其他字段释义

目前必填项:

- `email`
- `telephone`
- `position` 表示用户的职位

## 拉取组织架构列表

请求方法： `GET`

预期的返回体结构

```json
{
  "count": 100,
  "results": [
  {
    "name": "总公司",
    "code": "qwer-zxcv-asdf",
    "parent": null,
  },
  {
    "name": "子部门A",
    "code": "qwer-zxcv-asdf",
    "parent": "1",
  }
  ]
}
```

### name 字段释义

同一个父组织下，组织名不能重复，但是不同父组织时没有要求。

### parent 字段释义

指向该部门的父组织 `code` ，若不指定会被视作根组织，所以需要保证其存在性。

## 同步注意事项

### 多目录

用户管理支持多目录，可以在多个目录中配置同样的拉取内容，即使对象的 `code` 一样，在不同目录拉取之后，都会被视作不同的对象。

### 用户状态

如果用户在用户管理侧处于特殊状态（例如登录多次失败被锁定），同步则并不会刷新用户状态。

### 分页拉取（非一期目标）

原则上，我们更倾向于“少次多量”的数据拉取方式，即尽可能在一次数据拉取中提供全量的内容。

当然，考虑到全量数据的处理，对于提供方的接口效率有一定挑战，所以我们也支持分页拉取，需要在配置中配置相关的分页信息，调整每次拉取的分页大小。

为了保证分页内容的完整性（例如 `leaders`、 `parent`字段），同步方会一次性将所有内容都请求出来，然后当作全量数据一起处理。

### 失败回滚

- 同步过程内部分为两步（有先后顺序）：
    - 同步组织
    - 同步用户（包含用户和组织的关系、用户与上级的关系）

两个步骤是两个独立的事务，任意步骤失败都会致使该步骤数据回滚，但如果同步组织已成功，同步用户失败，则不会回滚组织数据。
